### Usages: perl accuracy_statistics_1.pl rand-mask-3.pos before_imputation.vcf(no-mask) after_imputation.vcf results_output.txt 
### By Junling Pang


################# random-masking SNP sites ########
#chr	SNP_pos	No-of-cols-start-from-0
#
#head SNP_318merge.confirmed.all.rand-mask-3.pos
#1       317     286     44      318
#1       430     307     95      14
#
################ vcf after beagle imputation #########
#10      1368    .       G       A       .       PASS    .       GT      1|0     1|0     0|1     0|1     0|1     0|0     1|0     1|0     0|1     1|0     0|1     1|0     1|0     1|0     0|1     1|1     0|0     1|0     0|1     1|0     1|0     1|0     1|0     0|1 1|0 1|0 0|0       1|0     0|1     1|0     0|1     0|0     1|0     0|1     1|0     0|0     1|0     0|1     0|1     0|0     0|0     1|0     1|0     0|1     1|0     0|1     0|1     0|1     1|0     1|0     0|1     1|1     1|0     0|1     0|1     0|0     1|0     1|0     0|1 0|1 1|0 1|0       0|1     0|1     0|0     0|1     1|0     0|0     1|0     1|0     0|1     0|0     1|0     1|0     1|0     0|1     1|0     0|1     1|0     0|1     0|1     1|0     1|0     0|1     1|0     1|0     1|0     1|0     1|0     1|0     1|0     0|1     1|0     1|0 0|1 0|1 1|0       0|0     0|1     1|0     0|0     1|1     1|0     0|0     0|0     1|0     1|0     1|0     0|1     0|0     0|1     0|0     0|0     1|0     0|0     0|0     0|1     0|1     0|1     0|1     0|1     1|0     1|0     0|0     1|0     0|0     0|1     1|0     1|0 1|0 1|0 0|1       0|1     0|0     0|1     0|1     0|1     0|0     1|1     1|0     1|0     0|0     0|0     0|1     0|1     1|0     0|1     1|0     0|1     0|1     1|1     1|0     0|1     0|1     0|0     0|1     1|0     1|0     0|1     0|1     0|1     1|0     1|1     1|0 0|1 1|0 1|0       1|0     1|0     1|1     0|1     0|0     0|0     0|1     0|0     1|0     0|0     1|0     0|1     0|1     1|0     0|0     0|1     0|1     0|1     0|0     0|1     1|0     0|1     0|1     0|1     1|1     1|0     1|1     1|0     1|0     1|0     1|0     0|1 0|0 1|0 1|0       0|1     0|1     0|1     1|0     1|0     0|1     0|1     0|1     0|1     1|0     0|0     1|0     0|1     1|0     1|0     1|0     1|0     0|0     1|0     0|1     1|0     0|1     0|0     0|0     1|0     1|0     1|0     1|0     1|0     0|1     0|1     0|1 1|0 0|1 0|1       0|0     0|1     0|1     1|0     1|0     0|1     1|0     1|0     0|1     0|1     0|0     0|1     1|0     0|1     1|0     1|0     0|1     1|1     1|0     0|0     0|0     0|1     1|0     0|0     0|1     0|1     0|1     1|0     0|1     1|0     0|0     1|0 1|0 1|0 1|1       0|0     1|0     0|1     1|0     1|0     1|0     1|1     1|0     0|0     0|1     1|0     1|0     0|0     0|1     0|0     0|1     0|1     0|1     0|1     1|0     1|0     0|1     0|1     1|0     0|1     0|1     0|1     0|0     0|1     1|0     1|1     0|1 0|1 1|0 1|0       1|0     0|1     0|0     1|0     1|0     1|0     1|0     0|0     1|0     1|0     1|0
#
############### vcf with masked SNP ###########
#10      300916  .       A       G       0       LowQual AC=3;AF=5.929e-03;AN=506;BaseQRankSum=-0.967;ClippingRankSum=0.000;DP=838;ExcessHet=3.0103;FS=0.000;MLEAC=0;MLEAF=0.00;MQ=50.00;MQRankSum=0.000;ReadPosRankSum=-0.431;set=FilteredInAll GT:AD:DP:GQ:PL  ./. ./. ./. 0/0:2,0:2:6:0,6,70        0/0:1,0:1:3:0,3,34      0/0:5,0:5:15:0,15,156   0/0:1,0:1:3:0,3,35      0/0:1,0:1:3:0,3,34      0/0:2,0:2:6:0,6,49      0/0:3,0:3:9:0,9,85      0/0:4,0:4:12:0,12,147   0/0:8,0:8:24:0,24,239   0/0:3,0:3:9:0,9,83      0/0:1,0:1:3:0,3,36 0/0:1,0:1:3:0,3,38 0/0:1,0:1:3:0,3,35      0/0:2,0:2:6:0,6,90      0/0:3,0:3:9:0,9,81      0/0:2,0:2:6:0,6,49      0/0:4,0:4:12:0,12,120   0/0:2,0:2:6:0,6,70      0/0:1,0:1:3:0,3,34      0/0:2,0:2:6:0,6,71      0/0:5,0:5:15:0,15,153   0/0:2,0:2:6:0,6,72      ./.     0/0:2,0:2:6:0,6,72    0/0:2,0:2:6:0,6,71      0/0:3,0:3:9:0,9,104     0/0:1,0:1:3:0,3,36      0/0:1,0:1:3:0,3,35      0/0:2,0:2:6:0,6,71      0/0:2,0:2:6:0,6,62      0/0:3,0:3:9:0,9,85      ./.     0/0:1,0:1:3:0,3,39      0/0:1,0:1:3:0,3,36      0/0:4,0:4:12:0,12,99    ./. 0/0:2,0:2:6:0,6,70        0/0:5,0:5:15:0,15,147   ./.     0/0:2,0:2:6:0,6,71      ./.     0/0:5,0:5:15:0,15,140   0/0:5,0:5:15:0,15,153   0/0:2,0:2:6:0,6,90      0/0:5,0:5:15:0,15,125   0/0:2,0:2:6:0,6,70      ./.     0/0:1,0:1:3:0,3,35      0/0:6,0:6:18:0,18,144   ./. 0/0:3,0:3:9:0,9,84        0/0:3,0:3:9:0,9,100     0/0:5,0:5:15:0,15,174   0/0:3,0:3:9:0,9,99      ./.     0/0:4,0:4:12:0,12,119   0/0:4,0:4:12:0,12,137   0/0:9,0:9:27:0,27,266   0/0:3,0:3:9:0,9,101     0/0:2,0:2:6:0,6,67      0/0:2,0:2:6:0,6,71      0/0:3,0:3:9:0,
#
########################################################
#!usr/bin/perl
use strict;
my(@hang,%site,@site,$n,$m,$na,@before,%before,@after,%missing,$tmp1,$tmp2);

open F1,"<$ARGV[0]";  ### SNP_318merge.confirmed.all.rand-mask-3.pos      3 or less SNPs are masked
while(<F1>)
{chomp;
 @hang=split;
 $site{$hang[0]."\t".$hang[1]}=join("\t",@hang);
}
close F1;

open F2,"<$ARGV[1]";  ### SNP_318merge.confirmed.all.chr10.vcf    before imputation
while(<F2>)
{if($_!~/^#/)
  {chomp;
   $na=0;
   @before=();
   @hang=split/\t/;
   @site=split(/\t/,$site{$hang[0]."\t".$hang[1]});
   for($m=2;$m<=$#site;$m++)           ### the masked sites before imputation
     {$before[$m]=$hang[$site[$m]];
     }
   $before{$hang[0]."\t".$hang[1]}=join("\t",@before);
   for($n=9;$n<=$#hang;$n++)   ### statistics of missing sites
    {if($hang[$n]=~/\.\/\./)
      {$na++;}
    }
   $missing{$hang[0]."\t".$hang[1]}=$na;
  }
}
close F2;

open OUT,">>$ARGV[3]";
print OUT "# Totatl 318 samples; for each SNP site, mask 3 or less samples.\n";
print OUT "# chr\tpos\ttotal_sample\tmissing_sample\tmask-SNPs\timpute-SNPs\n";

open F3,"<$ARGV[2]"; ###  SNP_318merge.confirmed.all.rand-mask-3.chr10.beagle-no-ref.vcf.vcf    after imputation
while(<F3>)
{if($_!~/^#/)
  {chomp;
   @after=();
   @hang=split/\t/;
   @site=split(/\t/,$site{$hang[0]."\t".$hang[1]});
   for($m=2;$m<=$#site;$m++)           ### the masked sites after imputation
     {$after[$m]=$hang[$site[$m]];
     }

   print OUT "$hang[0]\t$hang[1]\t318\t";
   $tmp1=$missing{$hang[0]."\t".$hang[1]};
   print OUT "$tmp1\t";
   $tmp2=$before{$hang[0]."\t".$hang[1]};
   print OUT "$tmp2\t";
   print OUT join("\t",@after);
   print OUT "\n";
  }

}
close F3;


close OUT;
